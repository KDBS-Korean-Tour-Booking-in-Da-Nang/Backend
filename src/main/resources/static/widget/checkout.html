<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
  <link rel="stylesheet" type="text/css" href="/widget/style.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>토스페이먼츠 샘플 프로젝트</title>
  <!-- SDK 추가 -->
  <script src="https://js.tosspayments.com/v2/standard"></script>
</head>

<body>
<!-- 주문서 영역 -->
<div class="wrapper">
  <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
    <!-- 결제 UI -->
    <div id="payment-method"></div>
    <!-- 이용약관 UI -->
    <div id="agreement"></div>
    <!-- 쿠폰 체크박스 -->
    <div style="padding-left: 30px">
      <div class="checkable typography--p">
        <label for="coupon-box" class="checkable__label typography--regular"
        ><input id="coupon-box" class="checkable__input" type="checkbox" aria-checked="true" /><span class="checkable__label-text">5,000원 쿠폰 적용</span></label
        >
      </div>
    </div>
    <!-- 결제하기 버튼 -->
    <button class="button" id="payment-button" style="margin-top: 30px">결제하기</button>
  </div>
  <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
    <!-- 브랜드페이만 연동하기 -->
    <button class="button" id="brandpay-button" style="margin-top: 30px">위젯 없이 브랜드페이만 연동하기</button>
    <!-- 결제창만 연동하기 -->
    <button class="button" id="payment-window-button" style="margin-top: 30px">위젯 없이 결제창만 연동하기</button>
  </div>
</div>
<script>
  async function main() {
    // TODO: Dán token từ Postman vào đây (chỉ dùng để TEST)

    // Lấy bookingId từ query (?bookingId=123)
    const bookingId = Number(new URLSearchParams(location.search).get("bookingId") || 0);
    if (!bookingId) {
      alert("Thiếu bookingId trên URL. Ví dụ: /widget/checkout.html?bookingId=123");
      return;
    }

    try {
      // 1) Gọi BE tạo order & lấy cấu hình Toss (yêu cầu AUTH)
      const createRes = await fetch("/api/toss/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ bookingId })
      });

      if (createRes.status === 401 || createRes.status === 403) {
        alert("Unauthorized/Forbidden: Token không hợp lệ hoặc hết hạn.");
        return;
      }

      const data = await createRes.json();

      if (!data || data.success === false) {
        alert(data.message || "Cannot create order");
        return;
      }

      // Destructure cấu hình FE từ BE
      const {
        clientKey,
        customerKey,
        amount,
        orderId,
        successUrl,
        failUrl
      } = data;

      console.log('clientKey:', clientKey);

      // 2) Khởi tạo Toss Payments Widget
      const tossPayments = TossPayments(clientKey);
      const widgets = tossPayments.widgets({ customerKey });

      // Nếu backend trả BigDecimal dạng string -> ép về Number
      const payValue = typeof amount === "string" ? Number(amount) : Number(amount);

      // NOTE: Nếu bạn test bằng KRW sandbox thì để "KRW".
      // Nếu muốn VND (tùy cấu hình môi trường) thì đổi "VND".
      await widgets.setAmount({ currency: "KRW", value: payValue });

      await Promise.all([
        widgets.renderPaymentMethods({ selector: "#payment-method", variantKey: "DEFAULT" }),
        widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" }),
      ]);

      // 3) Nút "결제하기" mở payment sheet
      document.getElementById("payment-button").addEventListener("click", async () => {
        await widgets.requestPayment({
          orderId,
          orderName: "Booking payment",
          successUrl, // ví dụ: http://localhost:8080/widget/success.html
          failUrl     // ví dụ: http://localhost:8080/fail.html
        });
      });
    } catch (err) {
      console.error(err);
      alert("Lỗi khi tạo order hoặc render widget.");
    }
  }

  // auto-run
  main();
</script>
</body>
</html>
